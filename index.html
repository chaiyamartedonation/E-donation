<!DOCTYPE html>
<html lang="th" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการบุญ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f9fafb; /* gray-50 */
        }
        .sidebar {
            background-color: #1f2937; /* gray-800 */
        }
        .nav-link {
            color: #d1d5db; /* gray-300 */
            transition: all 0.2s ease-in-out;
            border-left: 4px solid transparent;
        }
        .nav-link:hover {
            background-color: #374151; /* gray-700 */
            color: white;
        }
        .nav-link.active {
            border-left-color: #4f46e5; /* indigo-600 */
            background-color: #111827; /* gray-900 */
            color: white;
        }
        .header-title { color: #111827; } /* gray-900 */
        .header-subtitle { color: #6b7280; } /* gray-500 */
        .card { background-color: white; }
        .card-title { color: #111827; border-color: #e5e7eb;} /* gray-900, gray-200 */
        .table-header { background-color: #f3f4f6; } /* gray-100 */
        .table-header-text { color: #4b5563; } /* gray-600 */
        .hover-row:hover { background-color: #eef2ff; } /* indigo-50 */
        
        .tab-content, .dashboard-sub-content { display: none; }
        .tab-content.active, .dashboard-sub-content.active { display: block; }
        input:disabled, select:disabled, button:disabled { background-color: #e5e7eb; cursor: not-allowed; opacity: 0.7; }
        .dashboard-nav-link { border-color: transparent; transition: all 0.2s ease-in-out; color: #6b7280; }
        .dashboard-nav-link.active { border-color: #4f46e5; color: #4338ca; } /* indigo-600, indigo-700 */
    </style>
</head>
<body>

    <div class="relative min-h-screen md:flex">
        <!-- Mobile menu overlay -->
        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="sidebar w-64 shadow-xl flex-shrink-0 fixed inset-y-0 left-0 z-40 transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:translate-x-0">
            <div class="p-4 text-center border-b border-gray-700 flex flex-col items-center">
                <img src="https://img2.pic.in.th/pic/-Ver.3-1.png" alt="โลโก้วัดไชยามาตย์" class="h-24 w-24">
                <h1 class="text-xl font-bold text-white mt-2">วัดไชยามาตย์</h1>
                <div class="w-full p-4">
                    <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center space-x-2">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>เจ้าหน้าที่ Login</span>
                    </button>
                     <button id="logout-btn" class="hidden w-full bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 transition duration-300 flex items-center justify-center space-x-2">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
            <nav class="mt-2">
                <!-- User/Donor Section -->
                <div>
                    <h2 class="text-xs font-semibold text-gray-400 uppercase px-6 mb-2">สำหรับผู้บริจาค</h2>
                    <div class="flex flex-col space-y-1">
                        <button class="nav-link active w-full text-left py-3 px-6 flex items-center space-x-3" data-tab="donate">
                            <i class="fas fa-donate w-5 text-center"></i>
                            <span>บริจาคออนไลน์</span>
                        </button>
                        <button class="nav-link w-full text-left py-3 px-6 flex items-center space-x-3" data-tab="request-receipt">
                            <i class="fas fa-file-invoice-dollar w-5 text-center"></i>
                            <span>ขอใบลดหย่อนภาษี</span>
                        </button>
                    </div>
                </div>
                
                <hr class="my-6 border-gray-700">

                <!-- Staff Section (Hidden by default) -->
                <div id="staff-menu" class="hidden">
                    <h2 class="text-xs font-semibold text-gray-400 uppercase px-6 mb-2">สำหรับเจ้าหน้าที่</h2>
                    <div class="flex flex-col space-y-1">
                         <button class="nav-link w-full text-left py-3 px-6 flex items-center space-x-3" data-tab="record">
                            <i class="fas fa-edit w-5 text-center"></i>
                            <span>บันทึกการบริจาค</span>
                        </button>
                        <button class="nav-link w-full text-left py-3 px-6 flex items-center space-x-3" data-tab="dashboard">
                            <i class="fas fa-chart-pie w-5 text-center"></i>
                            <span>สรุปผล</span>
                        </button>
                        <button class="nav-link w-full text-left py-3 px-6 flex items-center space-x-3" data-tab="announcer">
                            <i class="fas fa-bullhorn w-5 text-center"></i>
                            <span>ผู้ประกาศ</span>
                        </button>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 p-4 md:p-10 overflow-y-auto">
             <header class="relative text-center mb-8">
                <button id="menu-btn" class="absolute top-0 left-0 md:hidden p-2 rounded-md text-gray-500 hover:text-gray-900 hover:bg-gray-100 z-20">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
                <h1 class="header-title text-3xl md:text-4xl font-bold">ระบบจัดการบุญ</h1>
                <p class="header-subtitle mt-2">บริหารจัดการข้อมูลการบริจาคและออกใบลดหย่อนภาษี</p>
            </header>
            <main>
                <!-- Section 1: Online Donation -->
                <div id="donate" class="tab-content active">
                     <div class="card p-6 md:p-8 rounded-lg shadow-lg">
                        <h2 class="card-title text-xl md:text-2xl font-bold mb-6 border-b-2 pb-4 flex items-center space-x-3">
                            <i class="fas fa-donate text-indigo-600"></i>
                            <span>ระบบบริจาคออนไลน์</span>
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                             <!-- QR Code Section -->
                            <div class="flex flex-col items-center justify-center bg-gray-50 p-6 rounded-lg border-2 border-dashed border-gray-300">
                                <h3 class="text-xl font-semibold mb-4 text-gray-700">สแกน QR Code เพื่อบริจาค</h3>
                                <img src="https://img2.pic.in.th/pic/099400240646898.png" alt="QR Code for Donation" class="w-64 h-64 object-contain rounded-md shadow-lg">
                                <p class="mt-4 text-center text-gray-700">ใช้แอปพลิเคชันธนาคารบนมือถือของคุณ<br>เพื่อสแกนและทำการบริจาค</p>
                            </div>
                            <!-- Donation Form -->
                            <form id="donate-form">
                                <div class="space-y-6">
                                    <div>
                                        <label for="donor-name-1" class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล</label>
                                        <input type="text" id="donor-name-1" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="กรอกชื่อ-นามสกุล" required>
                                    </div>
                                    <div>
                                        <label for="amount-1" class="block text-sm font-medium text-gray-700 mb-1">จำนวนเงินบริจาค (บาท)</label>
                                        <input type="number" id="amount-1" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="ระบุจำนวนเงิน" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทการบริจาค</label>
                                        <div class="space-y-2">
                                            <div class="flex items-center"><input type="radio" name="donation-type-1" value="เงินสดนำส่งที่วัด" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked> <span class="ml-3 text-gray-700">เงินสดนำส่งที่วัด</span></div>
                                            <div class="flex items-center"><input type="radio" name="donation-type-1" value="โอนผ่านธนาคาร" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-3 text-gray-700">โอนผ่านธนาคาร (ลดหย่อนภาษีได้ทันที)</span></div>
                                            <div class="flex items-center"><input type="radio" name="donation-type-1" value="โรงทาน" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-3 text-gray-700">โรงทาน</span></div>
                                            <div class="flex items-center"><input type="radio" name="donation-type-1" value="ทรัพย์สิน" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-3 text-gray-700">ทรัพย์สิน</span></div>
                                            <div class="flex items-center">
                                                <input type="radio" name="donation-type-1" value="อื่น ๆ" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                                <span class="ml-3 text-gray-700">อื่น ๆ</span>
                                                <input type="text" id="other-type-1" class="ml-2 flex-grow p-2 border rounded-md" placeholder="โปรดระบุ">
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="notes-1" class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                                        <textarea id="notes-1" rows="3" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                    </div>
                                    <div>
                                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center space-x-2">
                                            <i class="fas fa-paper-plane"></i>
                                            <span>ส่งข้อมูล</span>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Record Donation -->
                <div id="record" class="tab-content">
                     <div class="card p-6 md:p-8 rounded-lg shadow-lg">
                        <h2 class="card-title text-xl md:text-2xl font-bold mb-6 border-b-2 pb-4 flex items-center space-x-3">
                            <i class="fas fa-edit text-indigo-600"></i>
                            <span>ระบบบันทึกบริจาค (สำหรับเจ้าหน้าที่)</span>
                        </h2>
                        <form id="record-form" class="space-y-8">
                            <!-- Part 1: Donor Info -->
                            <fieldset class="border p-6 rounded-md">
                                <legend class="text-lg font-semibold px-2 text-gray-700">ส่วนที่ 1: ข้อมูลผู้บริจาค</legend>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                    <div>
                                        <label for="donor-type-2" class="block text-sm font-medium text-gray-700 mb-1">ประเภทผู้บริจาค</label>
                                        <select id="donor-type-2" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                            <option>บุคคลธรรมดา</option>
                                            <option>นิติบุคคล/องค์กร</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="id-number-2" class="block text-sm font-medium text-gray-700 mb-1">เลขประจำตัว (13 หลัก)</label>
                                        <input type="text" id="id-number-2" class="w-full p-3 border border-gray-300 rounded-md" placeholder="สำหรับออกใบเสร็จ (ไม่บังคับ)">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="org-name-2" class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล / ชื่อองค์กร</label>
                                        <input type="text" id="org-name-2" class="w-full p-3 border border-gray-300 rounded-md" required>
                                    </div>
                                    <div>
                                        <label for="phone-2" class="block text-sm font-medium text-gray-700 mb-1">เบอร์โทรศัพท์ (10 หลัก)</label>
                                        <input type="text" id="phone-2" class="w-full p-3 border border-gray-300 rounded-md" placeholder="ไม่บังคับ">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="notes-2" class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                                        <textarea id="notes-2" rows="3" class="w-full p-3 border border-gray-300 rounded-md"></textarea>
                                    </div>
                                </div>
                            </fieldset>

                            <!-- Part 2: Donation Details -->
                            <fieldset class="border p-6 rounded-md">
                                <legend class="text-lg font-semibold px-2 text-gray-700">ส่วนที่ 2: รายละเอียดการบริจาค</legend>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทการบริจาค</label>
                                        <div class="flex flex-wrap gap-4">
                                            <div class="flex items-center"><input type="radio" name="donation-type-2" value="เงินสด" checked class="h-4 w-4 text-indigo-600"> <span class="ml-2 text-gray-700">เงินสด</span></div>
                                            <div class="flex items-center"><input type="radio" name="donation-type-2" value="โอนผ่านธนาคาร" class="h-4 w-4 text-indigo-600"> <span class="ml-2 text-gray-700">โอนผ่านธนาคาร</span></div>
                                            <div class="flex items-center"><input type="radio" name="donation-type-2" value="โรงทาน" class="h-4 w-4 text-indigo-600"> <span class="ml-2 text-gray-700">โรงทาน</span></div>
                                            <div class="flex items-center"><input type="radio" name="donation-type-2" value="ทรัพย์สิน" class="h-4 w-4 text-indigo-600"> <span class="ml-2 text-gray-700">ทรัพย์สิน</span></div>
                                            <div class="flex items-center"><input type="radio" name="donation-type-2" value="อื่น ๆ" class="h-4 w-4 text-indigo-600"> <span class="ml-2 text-gray-700">อื่น ๆ</span> <input type="text" id="other-type-2" class="ml-2 p-1 border rounded-md"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="amount-2" class="block text-sm font-medium text-gray-700 mb-1">จำนวนเงิน (บาท) / มูลค่าสิ่งของ</label>
                                        <input type="number" id="amount-2" class="w-full p-3 border border-gray-300 rounded-md" required>
                                    </div>
                                    <div>
                                        <label for="purpose-2" class="block text-sm font-medium text-gray-700 mb-1">วัตถุประสงค์การบริจาค</label>
                                        <select id="purpose-2" class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                            <option selected>เพื่อสมทบกฐินสามัคคี ประจำปี 2568</option>
                                            <option>เพื่อดำเนินการทั่วไป</option>
                                            <option disabled>เพื่องานนมัสการพระธาตุฯ ประจำปี 2569</option>
                                        </select>
                                    </div>
                                </div>
                            </fieldset>

                            <!-- Part 3: Documentation -->
                            <fieldset class="border p-6 rounded-md">
                                <legend class="text-lg font-semibold px-2 text-gray-700">ส่วนที่ 3: เอกสารหลักฐาน</legend>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">เอกสารหลักฐาน</label>
                                        <div class="flex space-x-6">
                                            <div class="flex items-center">
                                                <input type="radio" id="receipt-yes" name="receipt-request" value="yes" class="h-4 w-4 text-indigo-600">
                                                <label for="receipt-yes" class="ml-2 text-gray-700">ต้องการรับใบลดหย่อนภาษี</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input type="radio" id="receipt-no" name="receipt-request" value="no" checked class="h-4 w-4 text-indigo-600">
                                                <label for="receipt-no" class="ml-2 text-gray-700">ไม่ต้องการรับใบลดหย่อนภาษี</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-end">
                                        <label class="block text-sm font-medium text-gray-700">สถานะการดำเนินงาน:</label>
                                        <span id="status-display" class="ml-2 font-bold text-lg text-green-600">เสร็จสิ้น</span>
                                    </div>
                                </div>
                            </fieldset>

                            <div class="text-right">
                                <button type="submit" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center space-x-2">
                                    <i class="fas fa-save"></i>
                                    <span>บันทึกข้อมูล</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Section 3: Request Tax Receipt -->
                <div id="request-receipt" class="tab-content">
                     <div class="card p-6 md:p-8 rounded-lg shadow-lg">
                        <h2 class="card-title text-xl md:text-2xl font-bold mb-6 border-b-2 pb-4 flex items-center space-x-3">
                            <i class="fas fa-file-invoice-dollar text-indigo-600"></i>
                            <span>ระบบขอใบลดหย่อนภาษี</span>
                        </h2>
                        <form id="request-receipt-form" class="space-y-8">
                            <fieldset class="border p-6 rounded-md">
                                <legend class="text-lg font-semibold px-2 text-gray-700">ส่วนที่ 1: ข้อมูลทั่วไป</legend>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                    <div>
                                        <label for="tax-id-3" class="block text-sm font-medium text-gray-700 mb-1">เลขประจำตัวผู้เสียภาษี (13 หลัก)</label>
                                        <input type="text" id="tax-id-3" maxlength="13" class="w-full p-3 border border-gray-300 rounded-md" placeholder="ไม่ต้องใส่ขีด (-)" required>
                                    </div>
                                    <div>
                                        <label for="fullname-3" class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-สกุล</label>
                                        <input type="text" id="fullname-3" class="w-full p-3 border border-gray-300 rounded-md" required>
                                    </div>
                                    <div>
                                        <label for="phone-3" class="block text-sm font-medium text-gray-700 mb-1">เบอร์โทรศัพท์</label>
                                        <input type="text" id="phone-3" maxlength="10" class="w-full p-3 border border-gray-300 rounded-md" required>
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset class="border p-6 rounded-md">
                                <legend class="text-lg font-semibold px-2 text-gray-700">ส่วนที่ 2: ข้อมูลการบริจาค</legend>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทการบริจาค</label>
                                        <div class="flex flex-wrap gap-4">
                                            <div class="flex items-center"><input type="radio" name="donation-type-3" value="เงินสด" checked class="h-4 w-4 text-indigo-600"> <span class="ml-2 text-gray-700">เงินสด</span></div>
                                            <div class="flex items-center"><input type="radio" name="donation-type-3" value="โอนผ่านธนาคาร" class="h-4 w-4 text-indigo-600"> <span class="ml-2 text-gray-700">โอนผ่านธนาคาร</span></div>
                                            <div class="flex items-center"><input type="radio" name="donation-type-3" value="โรงทาน" class="h-4 w-4 text-indigo-600"> <span class="ml-2 text-gray-700">โรงทาน</span></div>
                                            <div class="flex items-center"><input type="radio" name="donation-type-3" value="ทรัพย์สิน" class="h-4 w-4 text-indigo-600"> <span class="ml-2 text-gray-700">ทรัพย์สิน</span></div>
                                            <div class="flex items-center"><input type="radio" name="donation-type-3" value="อื่น ๆ" class="h-4 w-4 text-indigo-600"> <span class="ml-2 text-gray-700">อื่น ๆ</span> <input type="text" id="other-type-3" class="ml-2 p-1 border rounded-md"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="amount-3" class="block text-sm font-medium text-gray-700 mb-1">จำนวนเงิน/มูลค่า (บาท)</label>
                                        <input type="number" id="amount-3" class="w-full p-3 border border-gray-300 rounded-md" required>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="notes-3" class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                                        <textarea id="notes-3" rows="3" class="w-full p-3 border border-gray-300 rounded-md"></textarea>
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset class="border p-6 rounded-md bg-yellow-100 border-yellow-200">
                                <legend class="text-lg font-semibold px-2 text-gray-700">ส่วนที่ 3: เงื่อนไขการยอมรับ</legend>
                                <div class="space-y-4 mt-4">
                                    <div class="flex items-start">
                                        <input id="consent-revenue" name="consent-revenue" type="checkbox" class="h-5 w-5 mt-1 text-indigo-600 border-gray-300 rounded">
                                        <label for="consent-revenue" class="ml-3 text-gray-700">ยินยอมให้นำข้อมูลการบริจาคเข้าสู่ระบบของกรมสรรพากรเพื่อการลดหย่อนภาษี</label>
                                    </div>
                                    <div class="flex items-start">
                                        <input id="consent-truth" name="consent-truth" type="checkbox" class="h-5 w-5 mt-1 text-indigo-600 border-gray-300 rounded">
                                        <label for="consent-truth" class="ml-3 text-gray-700">ข้าพเจ้าขอรับรองว่าข้อมูลทั้งหมดที่บันทึกเป็นความจริงและถูกต้องทุกประการ</label>
                                    </div>
                                </div>
                            </fieldset>

                            <div class="text-right">
                                <button id="submit-receipt-request" type="submit" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center space-x-2" disabled>
                                    <i class="fas fa-file-import"></i>
                                    <span>ยื่นคำขอ</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Section 4: Dashboard -->
                <div id="dashboard" class="tab-content">
                     <div class="card p-6 md:p-8 rounded-lg shadow-lg">
                        <h2 class="card-title text-xl md:text-2xl font-bold border-b-2 pb-4 mb-8 flex items-center space-x-3">
                            <i class="fas fa-chart-pie text-indigo-600"></i>
                            <span>สรุปผล Dashboard</span>
                        </h2>
                        
                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                            <div class="bg-blue-100 p-6 rounded-lg shadow">
                                <h3 class="text-blue-700 text-sm font-medium">ยอดบริจาคทั้งหมด (บาท)</h3>
                                <p id="total-donation-amount" class="text-3xl font-bold text-gray-900">฿ 0.00</p>
                            </div>
                            <div class="bg-green-100 p-6 rounded-lg shadow">
                                <h3 class="text-green-700 text-sm font-medium">จำนวนผู้บริจาค (ที่บันทึก)</h3>
                                <p id="total-donors" class="text-3xl font-bold text-gray-900">0 คน</p>
                            </div>
                            <div class="bg-red-100 p-6 rounded-lg shadow">
                                <h3 class="text-red-700 text-sm font-medium">คำขอใบลดหย่อนภาษี</h3>
                                <p id="total-receipt-requests" class="text-3xl font-bold text-gray-900">0 รายการ</p>
                            </div>
                            <div class="bg-orange-100 p-6 rounded-lg shadow">
                                <h3 class="text-orange-800 text-sm font-medium">สถานะรอดำเนินการ</h3>
                                <p id="pending-receipts" class="text-3xl font-bold text-gray-900">0 รายการ</p>
                            </div>
                        </div>

                        <!-- Dashboard Sub-navigation -->
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex flex-wrap space-x-8" aria-label="Tabs">
                                <button class="dashboard-nav-link active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-subtab="recorded">
                                    ข้อมูลที่เจ้าหน้าที่บันทึก
                                </button>
                                <button class="dashboard-nav-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-subtab="online">
                                    ข้อมูลบริจาคออนไลน์
                                </button>
                                <button class="dashboard-nav-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-subtab="requests">
                                    ข้อมูลคำขอใบลดหย่อนภาษี
                                </button>
                            </nav>
                        </div>

                        <!-- Dashboard Sub-content -->
                        <div class="mt-8">
                            <div id="dashboard-recorded" class="dashboard-sub-content active">
                                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                                    <h3 class="text-xl font-semibold text-gray-700">ตารางข้อมูลที่เจ้าหน้าที่บันทึก</h3>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="start-date-recorded" class="date-filter border rounded px-2 py-1 w-36" placeholder="วันที่เริ่มต้น">
                                        <input type="text" id="end-date-recorded" class="date-filter border rounded px-2 py-1 w-36" placeholder="วันที่สิ้นสุด">
                                        <button class="print-btn bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center space-x-2" data-table-id="dashboard-table-recorded-body" data-title="รายงานข้อมูลที่เจ้าหน้าที่บันทึก">
                                            <i class="fas fa-print"></i>
                                            <span>พิมพ์</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto border rounded-lg">
                                    <table class="min-w-full">
                                        <thead class="table-header">
                                            <tr>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">ชื่อ-นามสกุล</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">จำนวนเงิน (บาท)</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">ประเภท</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">วัตถุประสงค์</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">สถานะใบลดหย่อน</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">ดำเนินการ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dashboard-table-recorded-body" class="divide-y divide-gray-200 bg-white">
                                            <tr><td colspan="6" class="text-center p-8 text-gray-500">กำลังโหลดข้อมูล...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="dashboard-online" class="dashboard-sub-content">
                                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                                    <h3 class="text-xl font-semibold text-gray-700">ตารางข้อมูลบริจาคออนไลน์</h3>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="start-date-online" class="date-filter border rounded px-2 py-1 w-36" placeholder="วันที่เริ่มต้น">
                                        <input type="text" id="end-date-online" class="date-filter border rounded px-2 py-1 w-36" placeholder="วันที่สิ้นสุด">
                                        <button class="print-btn bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center space-x-2" data-table-id="dashboard-table-online-body" data-title="รายงานข้อมูลบริจาคออนไลน์">
                                            <i class="fas fa-print"></i>
                                            <span>พิมพ์</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto border rounded-lg">
                                    <table class="min-w-full">
                                        <thead class="table-header">
                                            <tr>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">วันที่</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">ชื่อ-นามสกุล</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">จำนวนเงิน (บาท)</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">ประเภท</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">หมายเหตุ</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">ดำเนินการ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dashboard-table-online-body" class="divide-y divide-gray-200 bg-white">
                                            <tr><td colspan="6" class="text-center p-8 text-gray-500">กำลังโหลดข้อมูล...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="dashboard-requests" class="dashboard-sub-content">
                                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                                    <h3 class="text-xl font-semibold text-gray-700">ตารางข้อมูลคำขอใบลดหย่อนภาษี</h3>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" id="start-date-requests" class="date-filter border rounded px-2 py-1 w-36" placeholder="วันที่เริ่มต้น">
                                        <input type="text" id="end-date-requests" class="date-filter border rounded px-2 py-1 w-36" placeholder="วันที่สิ้นสุด">
                                        <button class="print-btn bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center space-x-2" data-table-id="dashboard-table-requests-body" data-title="รายงานข้อมูลคำขอใบลดหย่อนภาษี">
                                            <i class="fas fa-print"></i>
                                            <span>พิมพ์</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto border rounded-lg">
                                    <table class="min-w-full">
                                        <thead class="table-header">
                                            <tr>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">วันที่ยื่นขอ</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">เลขประจำตัวผู้เสียภาษี</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">ชื่อ-สกุล</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">จำนวนเงิน (บาท)</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">ประเภท</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">เบอร์โทรศัพท์</th>
                                                <th class="py-3 px-4 text-left font-semibold table-header-text">ดำเนินการ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dashboard-table-requests-body" class="divide-y divide-gray-200 bg-white">
                                           <tr><td colspan="7" class="text-center p-8 text-gray-500">กำลังโหลดข้อมูล...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Section 5: Announcer -->
                <div id="announcer" class="tab-content">
                    <div class="card p-8 rounded-lg shadow-lg">
                        <h2 class="card-title text-xl md:text-2xl font-bold mb-6 border-b-2 pb-4 flex items-center space-x-3">
                            <i class="fas fa-bullhorn text-indigo-600"></i>
                            <span>หน้าจอสำหรับผู้ประกาศ</span>
                        </h2>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <!-- Current Announcement -->
                            <div class="lg:col-span-2">
                                <h3 class="text-xl font-semibold text-gray-700 mb-4">รายการที่จะประกาศ</h3>
                                <div id="current-announcement-card" class="bg-indigo-50 p-8 rounded-lg shadow-inner min-h-[300px] flex items-center justify-center">
                                    <!-- Current card will be injected here -->
                                    <p class="text-gray-500">ไม่มีรายการรอประกาศ</p>
                                </div>
                                <div class="mt-4 flex justify-center space-x-4">
                                    <button id="prev-btn" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 flex items-center space-x-2">
                                        <i class="fas fa-arrow-left"></i> <span>ย้อนกลับ (W)</span>
                                    </button>
                                    <button id="next-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 flex items-center space-x-2">
                                        <span>ต่อไป (E)</span> <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Announced List -->
                            <div>
                                <h3 class="text-xl font-semibold text-gray-700 mb-4">ประกาศแล้ว</h3>
                                <div id="announced-list" class="space-y-3 max-h-[60vh] overflow-y-auto bg-gray-50 p-4 rounded-lg">
                                    <!-- Announced items will be listed here -->
                                    <p class="text-gray-400 text-center">ยังไม่มีรายการที่ประกาศ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div id="login-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">สำหรับเจ้าหน้าที่</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="login-form">
                        <label for="password" class="block text-sm text-left font-medium text-gray-700 mb-1">รหัสเจ้าหน้าที่</label>
                        <input id="password" type="password" placeholder="กรอกรหัส" class="mb-3 px-3 py-2 text-gray-700 bg-white rounded text-md shadow-sm w-full border" required>
                        <p id="login-error" class="text-red-600 text-sm mb-3 hidden">รหัสไม่ถูกต้อง</p>
                        <div class="items-center px-4 py-3">
                            <button id="login-submit-btn" type="submit" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700">
                                เข้าสู่ระบบ
                            </button>
                        </div>
                    </form>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal-btn" type="button" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">
                        ยกเลิก
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <form id="edit-form">
                <input type="hidden" id="edit-doc-id">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4 border-b pb-2">แก้ไขข้อมูลการบริจาค</h3>
                
                <div class="space-y-6 max-h-[70vh] overflow-y-auto p-4">
                    <!-- Part 1: Donor Info -->
                    <fieldset class="border p-4 rounded-md">
                        <legend class="text-md font-semibold px-2 text-gray-700">ส่วนที่ 1: ข้อมูลผู้บริจาค</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <div>
                                <label for="edit-donorType" class="block text-sm font-medium text-gray-700">ประเภทผู้บริจาค</label>
                                <select id="edit-donorType" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                    <option>บุคคลธรรมดา</option>
                                    <option>นิติบุคคล/องค์กร</option>
                                </select>
                            </div>
                            <div>
                                <label for="edit-idNumber" class="block text-sm font-medium text-gray-700">เลขประจำตัว (13 หลัก)</label>
                                <input id="edit-idNumber" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="md:col-span-2">
                                <label for="edit-orgName" class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล / ชื่อองค์กร</label>
                                <input id="edit-orgName" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="edit-phone" class="block text-sm font-medium text-gray-700">เบอร์โทรศัพท์</label>
                                <input id="edit-phone" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="md:col-span-2">
                                <label for="edit-notes" class="block text-sm font-medium text-gray-700">หมายเหตุ</label>
                                <textarea id="edit-notes" rows="2" class="mt-1 w-full p-2 border border-gray-300 rounded-md"></textarea>
                            </div>
                        </div>
                    </fieldset>
    
                    <!-- Part 2: Donation Details -->
                    <fieldset class="border p-4 rounded-md">
                        <legend class="text-md font-semibold px-2 text-gray-700">ส่วนที่ 2: รายละเอียดการบริจาค</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <div>
                                <label for="edit-amount" class="block text-sm font-medium text-gray-700">จำนวนเงิน (บาท)</label>
                                <input id="edit-amount" type="number" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="edit-donationType" class="block text-sm font-medium text-gray-700">ประเภทการบริจาค</label>
                                <input id="edit-donationType" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="md:col-span-2">
                                <label for="edit-purpose" class="block text-sm font-medium text-gray-700">วัตถุประสงค์</label>
                                <select id="edit-purpose" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                    <option value="เพื่อสมทบกฐินสามัคคี ประจำปี 2568">เพื่อสมทบกฐินสามัคคี ประจำปี 2568</option>
                                    <option value="เพื่อดำเนินการทั่วไป">เพื่อดำเนินการทั่วไป</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>
    
                    <!-- Part 3: Documentation -->
                    <fieldset class="border p-4 rounded-md">
                        <legend class="text-md font-semibold px-2 text-gray-700">ส่วนที่ 3: เอกสารหลักฐาน</legend>
                        <div class="mt-2">
                            <label for="edit-receiptStatus" class="block text-sm font-medium text-gray-700">สถานะใบลดหย่อน</label>
                            <select id="edit-receiptStatus" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                                <option value="รอดำเนินการ">รอดำเนินการ</option>
                                <option value="เสร็จสิ้น">เสร็จสิ้น</option>
                                <option value="ไม่ต้องการ">ไม่ต้องการ</option>
                            </select>
                        </div>
                    </fieldset>
                </div>
    
                <div class="items-center px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse mt-4">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3 sm:w-auto sm:text-sm">
                        บันทึก
                    </button>
                    <button id="edit-modal-close" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                        ยกเลิก
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, serverTimestamp, updateDoc, query, orderBy, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB4K1Th2ApaDTZmXjhkAtPZtI4ZlFUCATU",
            authDomain: "e-donation-9f35d.firebaseapp.com",
            projectId: "e-donation-9f35d",
            storageBucket: "e-donation-9f35d.appspot.com",
            messagingSenderId: "694136323923",
            appId: "1:694136323923:web:aa3f3ca0a6bb1f03ffaba6",
            measurementId: "G-9FW0EN52S1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Thai Baht Text Function ---
        function ThaiBaht(number) {
            let bahttext = "";
            if (isNaN(number) || number === null) {
                return "";
            }
            
            number = parseFloat(number);
            if (number === 0) {
                return "ศูนย์บาทถ้วน";
            }

            let num = Math.floor(number);
            let satang = Math.round((number - num) * 100);

            let t = ["", "สิบ", "ร้อย", "พัน", "หมื่น", "แสน", "ล้าน"];
            let n = ["", "หนึ่ง", "สอง", "สาม", "สี่", "ห้า", "หก", "เจ็ด", "แปด", "เก้า"];

            let s = num.toString();
            let s_len = s.length;

            let s_rev = s.split('').reverse().join('');
            for (let i = 0; i < s_len; i++) {
                let digit = s_rev[i];
                if (digit !== '0') {
                    let unit = t[i];
                    let digitText = n[parseInt(digit)];

                    if (i % 6 === 1 && digit === '2') { 
                        digitText = "ยี่";
                    } else if (i % 6 === 1 && digit === '1') { 
                        digitText = "";
                    } else if (i === 0 && digit === '1' && s.length > 1) { 
                        digitText = "เอ็ด";
                    } else if (i % 6 === 0 && i >= 6) {
                        unit = "ล้าน";
                    }
                    bahttext = digitText + unit + bahttext;
                }
            }
            
            bahttext += "บาท";

            if (satang > 0) {
                let satangStr = satang.toString().padStart(2, '0');
                let s1 = satangStr[0];
                let s2 = satangStr[1];

                if (s1 !== '0') {
                    bahttext += (s1 === '2' ? 'ยี่' : (s1 === '1' ? '' : n[parseInt(s1)])) + 'สิบ';
                }
                if (s2 !== '0') {
                    bahttext += (s2 === '1' && s1 !== '0' ? 'เอ็ด' : n[parseInt(s2)]);
                }
                bahttext += 'สตางค์';
            } else {
                bahttext += "ถ้วน";
            }
            return bahttext;
        }

        // --- DOM Elements ---
        const tabs = document.querySelectorAll('.nav-link');
        const tabContents = document.querySelectorAll('.tab-content');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginModal = document.getElementById('login-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const staffMenu = document.getElementById('staff-menu');
        const clockElement = document.getElementById('clock');
        
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const editModalCloseBtn = document.getElementById('edit-modal-close');
        
        // --- Clock Logic ---
        function updateClock() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            if (clockElement) {
                clockElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }
        }

        setInterval(updateClock, 1000);
        updateClock();

        // --- Auth State Logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                staffMenu.classList.remove('hidden');
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                loginModal.classList.add('hidden');
                loadDashboardData();
            } else {
                staffMenu.classList.add('hidden');
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                unsubscribeAllListeners();
                tabs.forEach(item => item.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                document.querySelector('.nav-link[data-tab="donate"]').classList.add('active');
                document.getElementById('donate').classList.add('active');
            }
        });
        
        // --- Login/Logout UI Logic ---
        loginBtn.addEventListener('click', () => loginModal.classList.remove('hidden'));
        closeModalBtn.addEventListener('click', () => {
            loginModal.classList.add('hidden');
            loginError.classList.add('hidden');
        });
        logoutBtn.addEventListener('click', () => signOut(auth));
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = "admin@test.com";
            const password = document.getElementById('password').value;
            loginError.classList.add('hidden');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('password').value = ''; 
            } catch (error) {
                console.error("Login failed:", error.code);
                loginError.textContent = "รหัสไม่ถูกต้อง";
                loginError.classList.remove('hidden');
            }
        });

        // --- Tab Navigation Logic ---
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                if (tab.closest('#staff-menu') && !auth.currentUser) {
                    Swal.fire({
                        title: 'โปรดทราบ',
                        text: 'กรุณา Login สำหรับเจ้าหน้าที่ก่อน',
                        icon: 'info'
                    });
                    return;
                }
                tabs.forEach(item => item.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab)?.classList.add('active');
            });
        });

        // --- Firestore Data Handling ---
        const donateForm = document.getElementById('donate-form');
        donateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const typeRadio = document.querySelector('input[name="donation-type-1"]:checked');
            let donationType = typeRadio.value === 'อื่น ๆ' ? `อื่น ๆ: ${document.getElementById('other-type-1').value}` : typeRadio.value;
            try {
                await addDoc(collection(db, "donations"), {
                    name: donateForm['donor-name-1'].value,
                    amount: Number(donateForm['amount-1'].value),
                    type: donationType,
                    notes: donateForm['notes-1'].value,
                    createdAt: serverTimestamp()
                });
                Swal.fire({
                    title: 'สำเร็จ!',
                    text: 'ส่งข้อมูลการบริจาคสำเร็จ ขอบคุณครับ',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
                donateForm.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
                Swal.fire({
                    title: 'ผิดพลาด!',
                    text: 'เกิดข้อผิดพลาดในการบันทึกข้อมูล',
                    icon: 'error'
                });
            }
        });

        const recordForm = document.getElementById('record-form');
        recordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const typeRadio = document.querySelector('input[name="donation-type-2"]:checked');
            let donationType = typeRadio.value === 'อื่น ๆ' ? `อื่น ๆ: ${document.getElementById('other-type-2').value}` : typeRadio.value;
            const receiptStatus = document.querySelector('input[name="receipt-request"]:checked').value === 'yes' ? 'รอดำเนินการ' : 'ไม่ต้องการ';
            try {
                await addDoc(collection(db, "recorded_donations"), {
                    donorType: recordForm['donor-type-2'].value,
                    idNumber: recordForm['id-number-2'].value,
                    orgName: recordForm['org-name-2'].value,
                    phone: recordForm['phone-2'].value,
                    notes: recordForm['notes-2'].value,
                    donationType: donationType,
                    amount: Number(recordForm['amount-2'].value),
                    purpose: recordForm['purpose-2'].value,
                    receiptStatus: receiptStatus,
                    createdAt: serverTimestamp()
                });
                Swal.fire({
                    title: 'สำเร็จ!',
                    text: 'บันทึกข้อมูลการบริจาคสำเร็จ',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
                recordForm.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
                Swal.fire({
                    title: 'ผิดพลาด!',
                    text: 'เกิดข้อผิดพลาดในการบันทึกข้อมูล',
                    icon: 'error'
                });
            }
        });
        
        const requestReceiptForm = document.getElementById('request-receipt-form');
        requestReceiptForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const typeRadio = document.querySelector('input[name="donation-type-3"]:checked');
            let donationType = typeRadio.value === 'อื่น ๆ' ? `อื่น ๆ: ${document.getElementById('other-type-3').value}` : typeRadio.value;
            try {
                await addDoc(collection(db, "tax_receipt_requests"), {
                    taxId: requestReceiptForm['tax-id-3'].value,
                    fullName: requestReceiptForm['fullname-3'].value,
                    phone: requestReceiptForm['phone-3'].value,
                    donationType: donationType,
                    amount: Number(requestReceiptForm['amount-3'].value),
                    notes: requestReceiptForm['notes-3'].value,
                    createdAt: serverTimestamp()
                });
                Swal.fire({
                    title: 'สำเร็จ!',
                    text: 'ยื่นคำขอใบลดหย่อนภาษีสำเร็จ',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
                requestReceiptForm.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
                Swal.fire({
                    title: 'ผิดพลาด!',
                    text: 'เกิดข้อผิดพลาดในการบันทึกข้อมูล',
                    icon: 'error'
                });
            }
        });

        // --- Dashboard Data Loading & Filtering ---
        let unsubscribeRecorded = null, unsubscribeOnline = null, unsubscribeRequests = null, unsubscribeAnnouncer = null;
        let allDocsData = {}; // Cache for editing
        let allRecordedData = [], allOnlineData = [], allRequestData = [], allAnnouncerData = [];

        function unsubscribeAllListeners() {
            if (unsubscribeRecorded) unsubscribeRecorded();
            if (unsubscribeOnline) unsubscribeOnline();
            if (unsubscribeRequests) unsubscribeRequests();
            if (unsubscribeAnnouncer) unsubscribeAnnouncer();
        }

        function loadDashboardData() {
            unsubscribeAllListeners();
            const datePickerOnChange = () => {
                renderRecordedTable();
                renderOnlineTable();
                renderRequestsTable();
            };

            const fpConfig = { dateFormat: "Y-m-d", onChange: datePickerOnChange };
            flatpickr("#start-date-recorded", fpConfig);
            flatpickr("#end-date-recorded", fpConfig);
            flatpickr("#start-date-online", fpConfig);
            flatpickr("#end-date-online", fpConfig);
            flatpickr("#start-date-requests", fpConfig);
            flatpickr("#end-date-requests", fpConfig);

            const recordedRef = query(collection(db, "recorded_donations"), orderBy("createdAt", "desc"));
            unsubscribeRecorded = onSnapshot(recordedRef, (snapshot) => {
                allRecordedData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allDocsData = allRecordedData.reduce((acc, doc) => ({...acc, [doc.id]: doc }), {});
                renderRecordedTable();
            }, console.error);

            const onlineRef = query(collection(db, "donations"), orderBy("createdAt", "desc"));
            unsubscribeOnline = onSnapshot(onlineRef, (snapshot) => {
                allOnlineData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOnlineTable();
            }, console.error);

            const requestsRef = query(collection(db, "tax_receipt_requests"), orderBy("createdAt", "desc"));
            unsubscribeRequests = onSnapshot(requestsRef, (snapshot) => {
                allRequestData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRequestsTable();
            }, console.error);

            const announcerRef = query(collection(db, "recorded_donations"), orderBy("createdAt", "asc"));
            unsubscribeAnnouncer = onSnapshot(announcerRef, (snapshot) => {
                allAnnouncerData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAnnouncerView();
            }, console.error);
        }

        function filterDataByDate(data, startDate, endDate) {
            if (endDate) endDate.setHours(23, 59, 59, 999);
            return data.filter(item => {
                const itemDate = item.createdAt?.toDate();
                if (!itemDate) return false;
                const startMatch = startDate ? itemDate >= startDate : true;
                const endMatch = endDate ? itemDate <= endDate : true;
                return startMatch && endMatch;
            });
        }

        function renderRecordedTable() {
            const startDate = document.getElementById('start-date-recorded')._flatpickr.selectedDates[0];
            const endDate = document.getElementById('end-date-recorded')._flatpickr.selectedDates[0];
            const filteredData = filterDataByDate(allRecordedData, startDate, endDate);
            const tableBody = document.getElementById('dashboard-table-recorded-body');
            
            tableBody.innerHTML = '';
            let totalAmount = 0, pendingReceipts = 0;

            if (filteredData.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-500">ไม่พบข้อมูลในช่วงเวลาที่เลือก</td></tr>';
            } else {
                filteredData.forEach(data => {
                    tableBody.innerHTML += `
                        <tr class="hover-row" data-id="${data.id}">
                            <td class="py-3 px-4">${data.orgName}</td>
                            <td class="py-3 px-4 text-right">${(data.amount || 0).toLocaleString('th-TH')}</td>
                            <td class="py-3 px-4">${data.donationType}</td>
                            <td class="py-3 px-4">${data.purpose}</td>
                            <td class="py-3 px-4">${renderStatusBadge(data.receiptStatus)}</td>
                            <td class="py-3 px-4 text-center space-x-4">
                                <button class="text-indigo-600 hover:text-indigo-800 edit-btn" title="แก้ไข"><i class="fas fa-edit"></i></button>
                                <button class="text-red-600 hover:text-red-800 delete-btn" title="ลบ" data-collection="recorded_donations"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>`;
                });
            }
             // Update global stats based on unfiltered data
            allRecordedData.forEach(data => {
                totalAmount += data.amount || 0;
                if (data.receiptStatus === 'รอดำเนินการ') pendingReceipts++;
            });
            document.getElementById('total-donation-amount').textContent = `฿ ${totalAmount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('total-donors').textContent = `${allRecordedData.length} คน`;
            document.getElementById('pending-receipts').textContent = `${pendingReceipts} รายการ`;
        }

        function renderOnlineTable() {
            const startDate = document.getElementById('start-date-online')._flatpickr.selectedDates[0];
            const endDate = document.getElementById('end-date-online')._flatpickr.selectedDates[0];
            const filteredData = filterDataByDate(allOnlineData, startDate, endDate);
            const tableBody = document.getElementById('dashboard-table-online-body');
            tableBody.innerHTML = '';

            if (filteredData.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-500">ไม่พบข้อมูลในช่วงเวลาที่เลือก</td></tr>';
            } else {
                 filteredData.forEach(data => {
                     tableBody.innerHTML += `
                        <tr class="hover-row" data-id="${data.id}">
                            <td class="py-3 px-4">${formatFirebaseTimestamp(data.createdAt)}</td>
                            <td class="py-3 px-4">${data.name}</td>
                            <td class="py-3 px-4 text-right">${(data.amount || 0).toLocaleString('th-TH')}</td>
                            <td class="py-3 px-4">${data.type}</td>
                            <td class="py-3 px-4">${data.notes || ''}</td>
                            <td class="py-3 px-4 text-center"><button class="text-red-600 hover:text-red-800 delete-btn" title="ลบ" data-collection="donations"><i class="fas fa-trash-alt"></i></button></td>
                        </tr>`;
                 });
            }
        }

        function renderRequestsTable() {
            const startDate = document.getElementById('start-date-requests')._flatpickr.selectedDates[0];
            const endDate = document.getElementById('end-date-requests')._flatpickr.selectedDates[0];
            const filteredData = filterDataByDate(allRequestData, startDate, endDate);
            const tableBody = document.getElementById('dashboard-table-requests-body');
            tableBody.innerHTML = '';
            document.getElementById('total-receipt-requests').textContent = `${allRequestData.length} รายการ`;

            if (filteredData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">ไม่พบข้อมูลในช่วงเวลาที่เลือก</td></tr>';
            } else {
                filteredData.forEach(data => {
                    tableBody.innerHTML += `
                         <tr class="hover-row" data-id="${data.id}">
                            <td class="py-3 px-4">${formatFirebaseTimestamp(data.createdAt)}</td>
                            <td class="py-3 px-4">${data.taxId}</td>
                            <td class="py-3 px-4">${data.fullName}</td>
                            <td class="py-3 px-4 text-right">${(data.amount || 0).toLocaleString('th-TH')}</td>
                            <td class="py-3 px-4">${data.donationType}</td>
                            <td class="py-3 px-4">${data.phone}</td>
                            <td class="py-3 px-4 text-center"><button class="text-red-600 hover:text-red-800 delete-btn" title="ลบ" data-collection="tax_receipt_requests"><i class="fas fa-trash-alt"></i></button></td>
                        </tr>`;
                });
            }
        }

        function renderAnnouncerView() {
            const unannounced = allAnnouncerData.filter(d => !d.announced);
            const announced = allAnnouncerData.filter(d => d.announced);

            const currentCardContainer = document.getElementById('current-announcement-card');
            const announcedListContainer = document.getElementById('announced-list');

            // Render current announcement
            if (unannounced.length > 0) {
                const current = unannounced[0];
                 currentCardContainer.innerHTML = `
                    <div class="text-left w-full space-y-4" data-id="${current.id}">
                        <div>
                            <p class="text-2xl text-gray-600">ผู้บริจาค:</p>
                            <p class="text-5xl font-bold text-indigo-700">${current.orgName}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                               <p class="text-xl text-gray-600">จำนวนเงิน:</p>
                               <p class="text-3xl font-semibold text-green-600">${(current.amount || 0).toLocaleString('th-TH')} บาท</p>
                            </div>
                            <div>
                               <p class="text-xl text-gray-600">ประเภท:</p>
                               <p class="text-3xl font-semibold text-gray-800">${current.donationType}</p>
                            </div>
                        </div>
                        <div>
                            <p class="text-xl text-gray-600">หมายเหตุ:</p>
                            <p class="text-2xl text-gray-800">${current.notes || '-'}</p>
                        </div>
                    </div>
                `;
            } else {
                currentCardContainer.innerHTML = '<p class="text-gray-500 text-2xl">ไม่มีรายการรอประกาศ</p>';
            }

            // Render announced list
            announcedListContainer.innerHTML = '';
            if (announced.length > 0) {
                announced.slice().reverse().forEach(item => { // Show most recent announced first
                    announcedListContainer.innerHTML += `
                        <div class="bg-white p-3 rounded-md shadow-sm flex justify-between items-center">
                            <span class="text-gray-800">${item.orgName}</span>
                            <span class="font-semibold text-green-700">${(item.amount || 0).toLocaleString('th-TH')} ฿</span>
                        </div>
                    `;
                });
            } else {
                announcedListContainer.innerHTML = '<p class="text-gray-400 text-center">ยังไม่มีรายการที่ประกาศ</p>';
            }
        }

        function formatFirebaseTimestamp(timestamp) {
            return timestamp ? new Date(timestamp.seconds * 1000).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A';
        }
        
        // --- Dashboard Edit/Delete Logic ---
        document.getElementById('dashboard').addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const row = target.closest('tr');
            if (!row) return;
            const id = row.dataset.id;

            if (target.classList.contains('delete-btn')) {
                const collectionName = target.dataset.collection;
                Swal.fire({
                    title: 'คุณแน่ใจหรือไม่?', text: `คุณต้องการลบรายการนี้ใช่หรือไม่?`, icon: 'warning',
                    showCancelButton: true, confirmButtonColor: '#4f46e5', cancelButtonColor: '#d33',
                    confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            await deleteDoc(doc(db, collectionName, id));
                            Swal.fire('ลบแล้ว!', 'รายการของคุณถูกลบเรียบร้อยแล้ว', 'success');
                        } catch (err) {
                            Swal.fire('ผิดพลาด!', 'เกิดข้อผิดพลาดในการลบ', 'error');
                            console.error(err);
                        }
                    }
                });
            }
            
            if (target.classList.contains('edit-btn')) {
                const data = allDocsData[id];
                document.getElementById('edit-doc-id').value = id;
                document.getElementById('edit-donorType').value = data.donorType;
                document.getElementById('edit-idNumber').value = data.idNumber;
                document.getElementById('edit-orgName').value = data.orgName;
                document.getElementById('edit-phone').value = data.phone;
                document.getElementById('edit-notes').value = data.notes;
                document.getElementById('edit-amount').value = data.amount;
                document.getElementById('edit-donationType').value = data.donationType;
                document.getElementById('edit-purpose').value = data.purpose;
                document.getElementById('edit-receiptStatus').value = data.receiptStatus;
                editModal.classList.remove('hidden');
            }
        });
        
        // --- Edit Modal Logic ---
        editModalCloseBtn.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-doc-id').value;
            const updatedData = {
                donorType: document.getElementById('edit-donorType').value,
                idNumber: document.getElementById('edit-idNumber').value,
                orgName: document.getElementById('edit-orgName').value,
                phone: document.getElementById('edit-phone').value,
                notes: document.getElementById('edit-notes').value,
                amount: Number(document.getElementById('edit-amount').value),
                donationType: document.getElementById('edit-donationType').value,
                purpose: document.getElementById('edit-purpose').value,
                receiptStatus: document.getElementById('edit-receiptStatus').value
            };
            
            try {
                await updateDoc(doc(db, "recorded_donations", id), updatedData);
                editModal.classList.add('hidden');
                Swal.fire({
                    title: 'สำเร็จ!', text: 'อัปเดตข้อมูลเรียบร้อยแล้ว', icon: 'success',
                    timer: 1500, showConfirmButton: false
                });
            } catch (err) {
                 Swal.fire({ title: 'ผิดพลาด!', text: 'เกิดข้อผิดพลาดในการอัปเดตข้อมูล', icon: 'error' });
                console.error(err);
            }
        });

        function renderStatusBadge(status) {
            if (status === 'เสร็จสิ้น') return `<span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">เสร็จสิ้น</span>`;
            if (status === 'รอดำเนินการ') return `<span class="bg-orange-100 text-orange-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">รอดำเนินการ</span>`;
            return `<span class="bg-gray-100 text-gray-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">ไม่ต้องการ</span>`;
        }
        
        // --- Form Logic ---
        const receiptRadios = document.querySelectorAll('input[name="receipt-request"]');
        const statusDisplay = document.getElementById('status-display');
        receiptRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'yes') {
                    statusDisplay.textContent = 'รอดำเนินการ';
                    statusDisplay.className = 'ml-2 font-bold text-lg text-yellow-800';
                } else {
                    statusDisplay.textContent = 'เสร็จสิ้น';
                    statusDisplay.className = 'ml-2 font-bold text-lg text-green-700';
                }
            });
        });

        const consentRevenue = document.getElementById('consent-revenue');
        const consentTruth = document.getElementById('consent-truth');
        const submitReceiptButton = document.getElementById('submit-receipt-request');

        function checkConsent() {
            submitReceiptButton.disabled = !(consentRevenue.checked && consentTruth.checked);
        }
        
        if (consentRevenue && consentTruth) {
            checkConsent();
            consentRevenue.addEventListener('change', checkConsent);
            consentTruth.addEventListener('change', checkConsent);
        }

        // --- Dashboard Sub-Tab Navigation Logic ---
        const dashboardTabs = document.querySelectorAll('.dashboard-nav-link');
        const dashboardContents = document.querySelectorAll('.dashboard-sub-content');

        dashboardTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                dashboardTabs.forEach(item => item.classList.remove('active'));
                dashboardContents.forEach(content => content.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`dashboard-${tab.dataset.subtab}`)?.classList.add('active');
            });
        });

        // --- Print Logic ---
        document.querySelectorAll('.print-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tableId = button.dataset.tableId;
                const title = button.dataset.title;
                const startDateEl = document.getElementById(`start-date-${tableId.split('-')[2]}`);
                const endDateEl = document.getElementById(`end-date-${tableId.split('-')[2]}`);
                const startDateVal = startDateEl ? startDateEl.value : null;
                const endDateVal = endDateEl ? endDateEl.value : null;

                let dataToPrint;
                if (tableId.includes('recorded')) dataToPrint = allRecordedData;
                else if (tableId.includes('online')) dataToPrint = allOnlineData;
                else if (tableId.includes('requests')) dataToPrint = allRequestData;
                
                const filteredData = filterDataByDate(dataToPrint, startDateVal ? new Date(startDateVal) : null, endDateVal ? new Date(endDateVal) : null);

                let tableHeadHTML = '';
                let tableBodyHTML = '';
                let totalAmount = 0;

                // Generate table based on ID
                if (tableId.includes('recorded')) {
                    tableHeadHTML = `<tr><th>วันที่บันทึก</th><th>ชื่อ/องค์กร</th><th>จำนวนเงิน</th><th>ประเภทบริจาค</th><th>หมายเหตุ</th></tr>`;
                    filteredData.forEach(item => {
                        totalAmount += item.amount || 0;
                        tableBodyHTML += `<tr><td>${formatFirebaseTimestamp(item.createdAt)}</td><td>${item.orgName}</td><td style="text-align: right;">${(item.amount || 0).toLocaleString('th-TH')}</td><td>${item.donationType}</td><td>${item.notes || ''}</td></tr>`;
                    });
                    tableBodyHTML += `<tr style="font-weight: bold; background-color: #f3f4f6;"><td colspan="2" style="text-align: right;">รวมทั้งสิ้น</td><td style="text-align: right;">${totalAmount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td><td colspan="4" style="text-align: center;">(${ThaiBaht(totalAmount)})</td></tr>`;
                } else if (tableId.includes('online')) {
                    tableHeadHTML = `<tr><th>วันที่</th><th>ชื่อ-นามสกุล</th><th>จำนวนเงิน</th><th>ประเภท</th><th>หมายเหตุ</th></tr>`;
                    filteredData.forEach(item => {
                        totalAmount += item.amount || 0;
                        tableBodyHTML += `<tr><td>${formatFirebaseTimestamp(item.createdAt)}</td><td>${item.name}</td><td style="text-align: right;">${(item.amount || 0).toLocaleString('th-TH')}</td><td>${item.type}</td><td>${item.notes || ''}</td></tr>`;
                    });
                    tableBodyHTML += `<tr style="font-weight: bold; background-color: #f3f4f6;"><td colspan="2" style="text-align: right;">รวมทั้งสิ้น</td><td style="text-align: right;">${totalAmount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td><td colspan="2" style="text-align: center;">(${ThaiBaht(totalAmount)})</td></tr>`;
                } else if (tableId.includes('requests')) {
                    tableHeadHTML = `<tr><th>วันที่ยื่นขอ</th><th>เลขประจำตัวผู้เสียภาษี</th><th>ชื่อ-สกุล</th><th>เบอร์โทร</th><th>จำนวนเงิน</th><th>ประเภทบริจาค</th><th>หมายเหตุ</th></tr>`;
                     filteredData.forEach(item => {
                        totalAmount += item.amount || 0;
                        tableBodyHTML += `<tr><td>${formatFirebaseTimestamp(item.createdAt)}</td><td>${item.taxId}</td><td>${item.fullName}</td><td>${item.phone}</td><td style="text-align: right;">${(item.amount || 0).toLocaleString('th-TH')}</td><td>${item.donationType}</td><td>${item.notes || ''}</td></tr>`;
                    });
                     tableBodyHTML += `<tr style="font-weight: bold; background-color: #f3f4f6;"><td colspan="4" style="text-align: right;">รวมทั้งสิ้น</td><td style="text-align: right;">${totalAmount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td><td colspan="2" style="text-align: center;">(${ThaiBaht(totalAmount)})</td></tr>`;
                }


                const printWindow = window.open('', '', 'height=600,width=800');
                printWindow.document.write('<html><head><title>พิมพ์รายงาน</title>');
                printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
                 printWindow.document.write(`<style> body { font-family: 'Sarabun', sans-serif; } table { width: 100%; border-collapse: collapse; font-size: 12px; } th, td { border: 1px solid #ddd; padding: 8px; text-align: left;} th { background-color: #f2f2f2; } </style>`);
                printWindow.document.write('</head><body >');
                printWindow.document.write('<div class="container mx-auto p-8">');
                printWindow.document.write('<div class="text-center mb-8">');
                printWindow.document.write('<img src="https://img2.pic.in.th/pic/-Ver.3-1.png" alt="logo" class="h-24 w-24 mx-auto">');
                printWindow.document.write(`<h1 class="text-2xl font-bold mt-4">${title}</h1>`);
                printWindow.document.write(`<p>วัดไชยามาตย์</p>`);
                 if(startDateVal || endDateVal) {
                    printWindow.document.write(`<p>ช่วงวันที่: ${startDateVal || '...'} ถึง ${endDateVal || '...'}</p>`);
                 }
                printWindow.document.write(`<p>วันที่พิมพ์: ${new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'})}</p>`);
                printWindow.document.write('</div>');
                printWindow.document.write('<table>');
                printWindow.document.write(`<thead>${tableHeadHTML}</thead>`);
                printWindow.document.write(`<tbody>${tableBodyHTML}</tbody>`);
                printWindow.document.write('</table>');
                printWindow.document.write('</div>');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
            });
        });

        // --- Announcer Logic ---
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');

        async function handleNextAnnouncement() {
            const unannounced = allAnnouncerData.filter(d => !d.announced);
            if (unannounced.length > 0) {
                const docId = unannounced[0].id;
                try {
                    await updateDoc(doc(db, "recorded_donations", docId), { announced: true });
                    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, timerProgressBar: true });
                    Toast.fire({ icon: 'success', title: 'บันทึกการประกาศแล้ว' });
                } catch (err) {
                    console.error("Error updating announcement status:", err);
                    Swal.fire('ผิดพลาด!', 'ไม่สามารถบันทึกสถานะการประกาศได้', 'error');
                }
            }
        }

        async function handlePreviousAnnouncement() {
            const announced = allAnnouncerData.filter(d => d.announced);
            if (announced.length > 0) {
                const lastAnnouncedItem = announced[announced.length - 1]; 
                const docId = lastAnnouncedItem.id;
                try {
                    await updateDoc(doc(db, "recorded_donations", docId), { announced: false });
                    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, timerProgressBar: true });
                    Toast.fire({ icon: 'info', title: 'ย้อนกลับรายการล่าสุดแล้ว' });
                } catch (err) {
                    console.error("Error reverting announcement status:", err);
                    Swالfire('ผิดพลาด!', 'ไม่สามารถย้อนกลับสถานะการประกาศได้', 'error');
                }
            }
        }

        nextBtn.addEventListener('click', handleNextAnnouncement);
        prevBtn.addEventListener('click', handlePreviousAnnouncement);
        
        document.addEventListener('keydown', async (e) => {
            const announcerTab = document.getElementById('announcer');
            if (!announcerTab.classList.contains('active') || !auth.currentUser) return;
    
            if (e.key === 'PageDown' || e.key.toLowerCase() === 'e') {
                e.preventDefault();
                handleNextAnnouncement();
            }
    
            if (e.key.toLowerCase() === 'w') {
                e.preventDefault();
                handlePreviousAnnouncement();
            }
        });

        // --- Mobile Menu Logic ---
        const menuBtn = document.getElementById('menu-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            sidebar.classList.toggle('translate-x-0');
            overlay.classList.toggle('hidden');
        });

        overlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebar.classList.remove('translate-x-0');
            overlay.classList.add('hidden');
        });

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 768) { // md breakpoint
                    sidebar.classList.add('-translate-x-full');
                    sidebar.classList.remove('translate-x-0');
                    overlay.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>

